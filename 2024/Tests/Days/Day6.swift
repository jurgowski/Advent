import Testing
import Advent2024

private struct DPos: Hashable {
    let pos: Pos
    let dir: Direction
}

private enum Direction {
    case n
    case s
    case w
    case e
    
    var turn: Direction {
        switch self {
        case .n: return .e
        case .e: return .s
        case .s: return .w
        case .w: return .n
        }
    }
    
    func next(from: Pos) -> Pos {
        switch self {
        case .n: return Pos(from.x, from.y - 1)
        case .e: return Pos(from.x + 1, from.y)
        case .s: return Pos(from.x, from.y + 1)
        case .w: return Pos(from.x - 1, from.y)
        }
    }
}

private func startingPosition(_ map: [[Substring.Element]]) -> Pos {
    for y in 0..<map.count {
        for x in 0..<map[y].count {
            if map[y][x] == "^" {
                return Pos(x, y)
            }
        }
    }
    fatalError("Missing ^")
}

private func hasLoop(_ map: [[Substring.Element]], obstacle: Pos) -> Bool {
    var looped: Set<DPos> = []
    
    var currPos = startingPosition(map)
    var currD = Direction.n
    
    while !looped.contains(DPos(pos: currPos, dir: currD)) {
        looped.insert(DPos(pos: currPos, dir: currD))
        let next = currD.next(from: currPos)
        guard map.indices.contains(next.y), map[next.y].indices.contains(next.x) else {
            return false
        }
        if map[next.y][next.x] == "#" || obstacle == next {
            currD = currD.turn
        } else {
            currPos = next
        }
    }
    return true
}

private func part1(input: String) -> Int {
    let map = input
        .split(separator: "\n")
        .map { Array($0) }
    
    var visited: Set<Pos> = []
    var currPos = startingPosition(map)
    var currD = Direction.n
    
    while true {
        visited.insert(currPos)
        let next = currD.next(from: currPos)
        guard map.indices.contains(next.y), map[next.y].indices.contains(next.x) else {
            break
        }
        if map[next.y][next.x] == "#" {
            currD = currD.turn
        } else {
            currPos = next
        }
    }
    return visited.count
}

private func part2(input: String) -> Int {
    let map = input
        .split(separator: "\n")
        .map { Array($0) }
    
    var visited: [Pos] = []
    let startingPos = startingPosition(map)
    var currPos = startingPos
    var currD = Direction.n
    while true {
        visited.append(currPos)
        let next = currD.next(from: currPos)
        guard map.indices.contains(next.y), map[next.y].indices.contains(next.x) else {
            break
        }
        if map[next.y][next.x] == "#" {
            currD = currD.turn
        } else {
            currPos = next
        }
    }
    return Set(visited)
        .filter { $0 != startingPos }
        .map { pos in hasLoop(map, obstacle: pos) }
        .count { $0 }
}

@Test func testDay6DebugPart1() async throws {
    #expect(part1(input: debugInput) == 41)
}

@Test func testDay6Part1() throws {
    print(part1(input: input))
}

@Test func testDay6Part2() async throws {
    #expect(part2(input: debugInput) == 6)
}

@Test func testDay6DebugPart2() async throws {
    print(part2(input: input))
}


private let debugInput = """
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
"""


private let input = """
........#........................................#......#........#................................................................
....................................#......#.....#............#.............#..........#..........................................
......................#.......................................................#...................................................
.......#..#..#....#...#...#....#..............#......#.......#...#................#.......#.......................................
......................#....##...#.......#....#.......................................#....................#.......................
...#............................#........................................#..........................#.....................#.......
....................#............#...............#......#.........#...........#...................................................
............................#......#...#................#.............#...........................................................
.....#..#.........#....................#......................................................#........................#.........#
.........#..##.#.........#.............................................#...........#........#....................##...............
...............#....#.........................##......#.....................#..............................................#......
..................##...................................#...........#........#....#.............#..................#........#.#....
....................................#...................#..............................#............#.............................
.........#.....#................#..........................................#...................................#..............#...
...#....................#...................................#..##...................#.......#......................###.........#..
....................#............#....#.##....#.........#......#...#........................#.......................#..........#..
..............#...................................................................................#....................#..........
.........#................#..............................#............................#...#.................#...............#.....
............................................................................................#...#............................#....
............#....................#................................#....#...............................#....#.....................
........................................#.........#..................................................#..#..................#......
.............#.#............................#..#.....#............................................#....#..........................
................................................................................................#.........#..#..............#..#..
...........#..........#.#..#................#.#..#...#.........#..........................................#..........#..#.........
.............................#....................#.......#....#.....#....#......#....................#..#...............##.......
..........#..............................................................................#....#.........#..#................#.....
..#..#...............................................................#.......#........#...........................#...............
...........................................................................#...##....................#.#....##....................
.......................................#...............................................#.....................#.........#..........
.......................................................#.......#....#................#.....................................#......
.............#................#...................#.................#....................#..................#.#.........#.........
.....................................................................#.....................................#......................
........................#..........................................#....#..#.#..........................................#.........
............#.......#..................#.................................................#..............#.......................#.
.........................................................#...............#...#....#...........#.................................#.
.........................#..........................#..#........................................................#.................
...............#....................................#.......#......................................#............#.................
.#......................................................................................................#.........................
#...#........................................................#.................#....#....................#...........#............
..#.........#................................................................#................................#.............#.....
..................................#.........................................................................#................#....
..............#..............................................#........#..................................#........................
......#............................................#.................................#............................#...............
.......##..#.......................##............#...#...................#.#..........................................##..........
.#......#.....................................................................#..#..........................#......#.............#
.................#.....................#........##..#.........#........#................#.........................................
...........#.....#..........#........#............................................................................................
.........................#......#.......................................#..............................#..........................
............#............................................................#..............#..............................#..........
..................#.........#...........................................................................................#.........
#.#..................................#....................#......................#.............#.................................#
....#................#.................#...................#...........#......................................#...................
................#........................................................................................#....#.#.......#.....##..
..........#...#.......................................#........#.......................................#...#......................
.......#..##........................#......##.........................#.........#.......#.............................#.....#.....
................#...............................................#....#..........#.....#.........#.........#.........#.............
...............................#............#....................................#......#......................................#..
.#..#..................#............................................#....#............#...............##...#..........#...........
....#.............................................................................................................................
.............................................................#...........................#..........#.............................
.#........#..................#.....#.............#.....................................................#...#........#...........#.
.......................#........................................#.....#............................#.#..................#.........
................#....#................#.......#............................#.......#.................#............................
....#.........#....#........#.....................#........................#............#.........................................
.......#.......#.....................................................................##...........#...............................
...........#.........................................................#..........#............#....................................
..................#.............................#.......................................................................#.........
................#.....#........#.....#...#..........#.....................................#.....#........................#........
..........................................#.........#...........#.................................................................
...#.......................................................................................................#......................
....#..............#...........#..................................................#.................#.................#...........
.#................#.....#.#.................................................................#.........................#...........
............#.........................##....................................#..............#......................................
...##...........#...#............#..........................................................................#.....................
............................................#......................#......#.......................................................
............#............................................................................................................#........
...................##..............#.#....#.##...................................................#..................#.............
..#...................................................................................#.........#.........................#.....#.
........................#..............................................#......#................................................#..
................#............#............................#.#...................#.....................#...........................
..................#......#................#.#......................#...................#...#......................................
..#................................................##...................................................................#.........
...........................#......................................................................#......#...#......#.............
........................#...#........#......#.......#..........#.............................#........#.....#.....................
.................................................#..............................................#......#.....#....................
.....#....#.................#......#........#.#..............^...........................#...................#..#.................
.............................................................................#................................#...................
#..........................#..#..............#.......#..........................#.................................................
............#.............................................................................#...................#...................
..................#.............................#.........................................#................#.........#......#.....
...#...............................#.....#......#............###.#.#.....................................#....#.............#.....
...........#...........#...........................#..............................................................................
............#..........................................#.....#.............#..........................#....................#.....#
........................#......#..#............................#.......................................................#..........
..#...#...#.......#.#..........................................#.............#.........#....#..................#...........#......
..................#.......#.....................................................................................#........#........
......##................#...........................................#..............##.................................#...........
.................#................................................................................#.#....................#........
....................#.........#..........#...............#...#...#.#.#............................................................
#..................#.#..........#..#...................................................................................#..........
..........#........................................................#..........##..........................#..##...................
...........#...................................................................#..................................................
..................#........#............................................#..................#....#.......................#..#......
............#...................#......#..........................................................................................
...........................#.....##..........#.#..............#......................#.............#.......#...........#..........
............#..................................................#.......#.........#.#..................#..............##...........
#..................................................#...#......#..#......................#.............#........#............#.....
....#..................#..........#.........#.........................................#..................#................#.......
...#.................#.............................................................................#....................#.........
..........#.................................................................#............#....................#.#.#.....#.........
.....................#......................#...........#........#................................................................
.....#.......................................................................#......................#...#......#..................
.............##........#.....................#...........##........#............#.....#.....................#...............#.....
.....#.........#....#.................#....#...........#.......##..........#.........#.#......................................#...
.......#..................##.......#...#.#...#...................................#.......................................#.....#..
...............#.......#.................#........................................................................................
......#.......#.....#...............................#...........#.......#......................##...#....#........................
.##..........................##..................##................#..#....#...##.................................................
........#..............................#.#......#........#...............#....#........#.#........................................
...............................#..#.....................#.#...................#...................................................
.....................#.................................................##...#.......#.................##...............#.......#..
.............#..........................#.................................#..............#.......#..........#........#............
.........................................#...................#.........................................................#..........
...............................#..........#..............................#............#.....#.....................................
.............#..........................#....................#................................#...#............#..................
....#......#........#.......#......#................................................#...#......................................##.
..#...................................#........#.....................................#...#......#.........#..#..........#.........
.......#.........#................................................................................................................
...........#...............................##.........................................#..#....................#.....#.#.......##..
.........................#..#...............#............................#.............#..........................#..............#
"""
